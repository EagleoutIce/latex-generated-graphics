%% block icon network generator package
%% Florian Sihler, 2021-03-14
\ProvidesPackage{blk-ico-net}[2021/03/14 v1.0 blk icon network generator package]
\newif\ifiinet@setup@cpalette@
\DeclareOption{cpalette}{\iinet@setup@cpalette@true}
\DeclareOption{nocpalette}{\iinet@setup@cpalette@false}
\newif\ifiinet@setup@gradient@
\DeclareOption{gradient}{\iinet@setup@gradient@true}
\DeclareOption{nogradient}{\iinet@setup@gradient@false}
\newif\ifiinet@setup@pathfade@
\DeclareOption{pathfade}{\iinet@setup@pathfade@true}
\DeclareOption{nopathfade}{\iinet@setup@pathfade@false}
\newif\ifiinet@setup@frameblock@
\DeclareOption{frameblock}{\iinet@setup@frameblock@true}
\DeclareOption{noframeblock}{\iinet@setup@frameblock@false}
\DeclareOption{debug}{\let\iinet@debug\typeout}
\DeclareOption{nodebug}{\let\iinet@debug\@gobble}
\let\iinet@debug\@gobble
\ProcessOptions*
\RequirePackage{tikz,etoolbox}
\usetikzlibrary{backgrounds,decorations.markings}
\RequirePackage{blk-ico-net@register,blk-ico-net@debug}

\RequirePackage{blk-ico-net@matrix}
\RequirePackage{blk-ico-net@block}
\RequirePackage{blk-ico-net@routing}

\def\iinet@init#1{%
    \pgfkeys{/iinet@keys,defaults,#1}%
    \setcounter{iinet@block@count}{0}%
}

\newif\if@iinet@deadcycles@reached@
\newcommand*\blkIcoRandomNet[1][]{\blkIcoNet[#1]{
    \setcounter{iinet@block@a}{0}
    \@whilenum\value{iinet@block@a}<\iinet@block@max@count\do{%
        \iinet@draw@single@block
        \advance\c@iinet@block@a\@ne
    }
    \@iinet@deadcycles@reached@false
    % now ensure minimum is met
    \setcounter{iinet@block@a}{0}
    \@whilenum\value{iinet@block@count}<\iinet@block@min@count\do{%
        \iinet@draw@single@block
        \advance\c@iinet@block@a\@ne
        \ifnum\value{iinet@block@a}>\iinet@block@deadcycles@count\relax
            \PackageWarning{blk-ico-net}{Deadcycles reached.}
            \edef\iinet@tmpbc{\arabic{iinet@block@count}}%
            \setcounter{iinet@block@count}{\iinet@block@min@count}%
            \@iinet@deadcycles@reached@true
        \fi
    }
    \if@iinet@deadcycles@reached@\setcounter{iinet@block@count}{\iinet@tmpbc}\fi
    \iinet@debug@show@matrix% Debug :)
    \iinet@route@lines
}}

\newenvironment{blk@rootlayer}{\begin{pgfonlayer}{background}}{\end{pgfonlayer}}

\newcommand\blkIcoNet[2][]{\begingroup
\iinet@init{#1}%
\begin{tikzpicture}[x=1pt,y=1pt,scale=\iinet@scale]
    \let\get\iinet@getblock
    \let\setblock\iinet@setblock
    \let\setblockrand\iinet@setblockrand
    \iinet@calcdiffs% 1)
    \iinet@setup@matrix% 2)
    \def\iinet@outer@path{(-\iinet@padding@x,-\iinet@padding@y) rectangle (\iinet@width+\iinet@padding@x,\iinet@height+\iinet@padding@y)}
    \path[use as bounding box,\if@iinet@drawframe iinet@frame\fi]\iinet@outer@path;
    \path[clip,iinet@outer@roundings] \iinet@outer@path;
    \if@iinet@drawgrid\begin{pgfonlayer}{background}
        \path[clip,iinet@outer@roundings] \iinet@outer@path;
        \draw[iinet@grid] (-\iinet@padding@x,-\iinet@padding@y) grid (\iinet@width+\iinet@padding@x,\iinet@height+\iinet@padding@y);
    \end{pgfonlayer}\fi
    \let\debugmatrix\iinet@debug@show@matrix
    \let\autoroot\iinet@route@lines
    \let\block\iinet@fronte@draw@block
    \let\root\iinet@dl@root
    \let\rootlayer\blk@rootlayer
    \let\endrootlayer\endblk@rootlayer
    #2
\end{tikzpicture}%
\endgroup}
\endinput